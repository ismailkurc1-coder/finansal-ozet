<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finansal Y√∂netici √ñzeti</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
            color: #fff;
        }

        header h1 {
            font-size: 2rem;
            color: #e94560;
            margin-bottom: 10px;
        }

        header p {
            color: #a0a0a0;
        }

        /* Upload Section */
        .upload-section {
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            border: 2px dashed #374151;
            text-align: center;
            color: #fff;
            transition: all 0.3s;
        }

        .upload-section:hover {
            border-color: #e94560;
        }

        .upload-section.dragover {
            border-color: #e94560;
            background: rgba(233, 69, 96, 0.1);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .upload-section h2 {
            margin-bottom: 15px;
        }

        .upload-section p {
            color: #9ca3af;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(145deg, #e94560 0%, #c73e54 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(145deg, #c73e54 0%, #a33547 100%);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #374151;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: linear-gradient(145deg, #059669 0%, #047857 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(145deg, #047857 0%, #065f46 100%);
        }

        input[type="file"] {
            display: none;
        }

        .file-info {
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(5, 150, 105, 0.2);
            border-radius: 8px;
            color: #10b981;
            display: none;
        }

        /* Company Info Form */
        .company-form {
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            color: #fff;
            display: none;
        }

        .company-form.show {
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            color: #9ca3af;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #374151;
            background: #111827;
            color: #fff;
            font-size: 1rem;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #e94560;
        }

        /* Report Preview */
        .report-container {
            display: none;
        }

        .report-container.show {
            display: block;
        }

        .report-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        /* A4 Report */
        .report {
            background: #fff;
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 15mm;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            color: #333;
            font-size: 9pt;
        }

        .report-header {
            text-align: center;
            border-bottom: 3px solid #1a365d;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .report-header h1 {
            font-size: 18pt;
            color: #1a365d;
            margin-bottom: 5px;
        }

        .report-header .company-name {
            font-size: 14pt;
            font-weight: bold;
            color: #2d3748;
        }

        .report-header .period {
            font-size: 10pt;
            color: #718096;
        }

        /* Balance Sheet */
        .balance-sheet {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .sheet-column {
            border: 1px solid #e2e8f0;
        }

        .sheet-column h2 {
            background: #1a365d;
            color: #fff;
            padding: 8px 12px;
            font-size: 11pt;
            text-align: center;
        }

        .sheet-section {
            padding: 8px 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .sheet-section:last-child {
            border-bottom: none;
        }

        .sheet-section h3 {
            font-size: 9pt;
            color: #1a365d;
            margin-bottom: 5px;
            border-bottom: 1px solid #cbd5e0;
            padding-bottom: 3px;
        }

        .sheet-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            font-size: 8pt;
        }

        .sheet-item.sub-item {
            padding-left: 10px;
            color: #4a5568;
        }

        .sheet-item.total {
            font-weight: bold;
            border-top: 1px solid #cbd5e0;
            margin-top: 3px;
            padding-top: 3px;
        }

        .sheet-item .amount {
            font-family: 'Consolas', monospace;
        }

        .grand-total {
            background: #edf2f7;
            padding: 8px 12px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            font-size: 10pt;
        }

        /* Income Statement */
        .income-statement {
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
        }

        .income-statement h2 {
            background: #2d3748;
            color: #fff;
            padding: 8px 12px;
            font-size: 11pt;
            text-align: center;
        }

        .income-content {
            padding: 10px 15px;
        }

        .income-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 8pt;
        }

        .income-item.highlight {
            font-weight: bold;
            background: #f7fafc;
            padding: 5px;
            margin: 3px -5px;
        }

        .income-item.main-total {
            font-weight: bold;
            font-size: 9pt;
            border-top: 2px solid #1a365d;
            margin-top: 5px;
            padding-top: 5px;
        }

        /* Bottom Section */
        .bottom-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .cash-flow, .ratios {
            border: 1px solid #e2e8f0;
        }

        .cash-flow h2, .ratios h2 {
            background: #4a5568;
            color: #fff;
            padding: 6px 10px;
            font-size: 10pt;
            text-align: center;
        }

        .cash-flow-content, .ratios-content {
            padding: 8px 12px;
        }

        .ratio-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 8pt;
            border-bottom: 1px dotted #e2e8f0;
        }

        .ratio-item:last-child {
            border-bottom: none;
        }

        .ratio-value {
            font-weight: bold;
            color: #1a365d;
            font-family: 'Consolas', monospace;
        }

        .ratio-value.positive {
            color: #059669;
        }

        .ratio-value.negative {
            color: #dc2626;
        }

        .report-footer {
            margin-top: 15px;
            text-align: center;
            font-size: 7pt;
            color: #a0aec0;
            border-top: 1px solid #e2e8f0;
            padding-top: 10px;
        }

        /* Column Mapping Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            color: #fff;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #e94560;
        }

        .close-btn {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .mapping-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.85rem;
        }

        .preview-table th, .preview-table td {
            border: 1px solid #374151;
            padding: 8px;
            text-align: left;
        }

        .preview-table th {
            background: #374151;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #fff;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #374151;
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .report {
                width: 100%;
                min-height: auto;
                padding: 10px;
            }

            .balance-sheet {
                grid-template-columns: 1fr;
            }

            .bottom-section {
                grid-template-columns: 1fr;
            }
        }

        @media print {
            body {
                background: white;
            }
            .app-container {
                padding: 0;
            }
            header, .upload-section, .company-form, .report-actions {
                display: none !important;
            }
            .report {
                box-shadow: none;
                margin: 0;
                padding: 10mm;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>Finansal Y√∂netici √ñzeti</h1>
            <p>Mizan veya beyanname verilerinizden profesyonel tek sayfa rapor olu≈üturun</p>
        </header>

        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <div class="upload-icon">üìä</div>
            <h2>Excel veya CSV Dosyasƒ± Y√ºkleyin</h2>
            <p>Mizan, ge√ßici vergi beyannamesi veya kurumlar vergisi dosyanƒ±zƒ± s√ºr√ºkleyip bƒ±rakƒ±n</p>
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                üìÅ Dosya Se√ß
            </button>
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
            <div class="file-info" id="fileInfo"></div>
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="downloadTemplate()">
                    üì• √ñrnek ≈ûablon ƒ∞ndir
                </button>
            </div>
        </div>

        <!-- Company Info Form -->
        <div class="company-form" id="companyForm">
            <h2 style="margin-bottom: 20px; color: #e94560;">≈ûirket Bilgileri</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>≈ûirket Adƒ± *</label>
                    <input type="text" id="companyName" placeholder="ABC ≈ûirketi A.≈û.">
                </div>
                <div class="form-group">
                    <label>D√∂nem *</label>
                    <input type="text" id="period" placeholder="2024 - 4. √áeyrek">
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="generateReport()">
                    üìÑ Rapor Olu≈ütur
                </button>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Rapor olu≈üturuluyor...</p>
        </div>

        <!-- Report Container -->
        <div class="report-container" id="reportContainer">
            <div class="report-actions">
                <button class="btn btn-success" onclick="downloadPDF()">
                    üì• PDF ƒ∞ndir
                </button>
                <button class="btn btn-secondary" onclick="window.print()">
                    üñ®Ô∏è Yazdƒ±r
                </button>
                <button class="btn btn-secondary" onclick="resetForm()">
                    üîÑ Yeni Rapor
                </button>
            </div>

            <div class="report" id="report">
                <div class="report-header">
                    <h1>Y√ñNETƒ∞Cƒ∞ √ñZETƒ∞</h1>
                    <div class="company-name" id="reportCompanyName">≈ûirket Adƒ±</div>
                    <div class="period" id="reportPeriod">D√∂nem</div>
                </div>

                <!-- Balance Sheet -->
                <div class="balance-sheet">
                    <!-- Aktif -->
                    <div class="sheet-column">
                        <h2>AKTƒ∞F KALEMLERƒ∞</h2>

                        <div class="sheet-section">
                            <h3>D√ñNEN VARLIKLAR</h3>
                            <div class="sheet-item sub-item">
                                <span>Hazƒ±r Deƒüerler</span>
                                <span class="amount" id="hazirDegerler">0</span>
                            </div>
                            <div class="sheet-item sub-item">
                                <span>Ticari Alacaklar</span>
                                <span class="amount" id="ticariAlacaklar">0</span>
                            </div>
                            <div class="sheet-item sub-item">
                                <span>Stoklar</span>
                                <span class="amount" id="stoklar">0</span>
                            </div>
                            <div class="sheet-item sub-item">
                                <span>Diƒüer D√∂nen Varlƒ±klar</span>
                                <span class="amount" id="digerDonenVarliklar">0</span>
                            </div>
                            <div class="sheet-item total">
                                <span>TOPLAM D√ñNEN VARLIKLAR</span>
                                <span class="amount" id="toplamDonenVarliklar">0</span>
                            </div>
                        </div>

                        <div class="sheet-section">
                            <h3>DURAN VARLIKLAR</h3>
                            <div class="sheet-item sub-item">
                                <span>Maddi Duran Varlƒ±klar</span>
                                <span class="amount" id="maddiDuranVarliklar">0</span>
                            </div>
                            <div class="sheet-item sub-item">
                                <span>Maddi Olmayan D.V.</span>
                                <span class="amount" id="maddiOlmayanDV">0</span>
                            </div>
                            <div class="sheet-item sub-item">
                                <span>Diƒüer Duran Varlƒ±klar</span>
                                <span class="amount" id="digerDuranVarliklar">0</span>
                            </div>
                            <div class="sheet-item total">
                                <span>TOPLAM DURAN VARLIKLAR</span>
                                <span class="amount" id="toplamDuranVarliklar">0</span>
                            </div>
                        </div>

                        <div class="grand-total">
                            <span>AKTƒ∞F TOPLAMI</span>
                            <span class="amount" id="aktifToplami">0</span>
                        </div>
                    </div>

                    <!-- Pasif -->
                    <div class="sheet-column">
                        <h2>PASƒ∞F KALEMLERƒ∞</h2>

                        <div class="sheet-section">
                            <h3>KISA VADELƒ∞ YABANCI KAYNAKLAR</h3>
                            <div class="sheet-item sub-item">
                                <span>Mali Bor√ßlar</span>
                                <span class="amount" id="kvykMaliBorclar">0</span>
                            </div>
                            <div class="sheet-item sub-item">
                                <span>Ticari Bor√ßlar</span>
                                <span class="amount" id="ticariBorclar">0</span>
                            </div>
                            <div class="sheet-item sub-item">
                                <span>Diƒüer Bor√ßlar</span>
                                <span class="amount" id="kvykDigerBorclar">0</span>
                            </div>
                            <div class="sheet-item total">
                                <span>TOPLAM KVYK</span>
                                <span class="amount" id="toplamKVYK">0</span>
                            </div>
                        </div>

                        <div class="sheet-section">
                            <h3>UZUN VADELƒ∞ YABANCI KAYNAKLAR</h3>
                            <div class="sheet-item sub-item">
                                <span>Mali Bor√ßlar</span>
                                <span class="amount" id="uvykMaliBorclar">0</span>
                            </div>
                            <div class="sheet-item sub-item">
                                <span>Diƒüer Bor√ßlar</span>
                                <span class="amount" id="uvykDigerBorclar">0</span>
                            </div>
                            <div class="sheet-item total">
                                <span>TOPLAM UVYK</span>
                                <span class="amount" id="toplamUVYK">0</span>
                            </div>
                        </div>

                        <div class="sheet-section">
                            <h3>√ñZKAYNAKLAR</h3>
                            <div class="sheet-item sub-item">
                                <span>√ñdenmi≈ü Sermaye</span>
                                <span class="amount" id="odenmiserSermaye">0</span>
                            </div>
                            <div class="sheet-item sub-item">
                                <span>Yedekler</span>
                                <span class="amount" id="yedekler">0</span>
                            </div>
                            <div class="sheet-item sub-item">
                                <span>D√∂nem Karƒ±/Zararƒ±</span>
                                <span class="amount" id="donemKari">0</span>
                            </div>
                            <div class="sheet-item total">
                                <span>TOPLAM √ñZKAYNAKLAR</span>
                                <span class="amount" id="toplamOzkaynaklar">0</span>
                            </div>
                        </div>

                        <div class="grand-total">
                            <span>PASƒ∞F TOPLAMI</span>
                            <span class="amount" id="pasifToplami">0</span>
                        </div>
                    </div>
                </div>

                <!-- Income Statement -->
                <div class="income-statement">
                    <h2>GELƒ∞R TABLOSU</h2>
                    <div class="income-content">
                        <div class="income-item">
                            <span>Net Satƒ±≈ülar</span>
                            <span class="amount" id="netSatislar">0</span>
                        </div>
                        <div class="income-item">
                            <span>Satƒ±≈ülarƒ±n Maliyeti (-)</span>
                            <span class="amount" id="satislarinMaliyeti">0</span>
                        </div>
                        <div class="income-item highlight">
                            <span>BR√úT KAR/ZARAR</span>
                            <span class="amount" id="brutKar">0</span>
                        </div>
                        <div class="income-item">
                            <span>Faaliyet Giderleri (-)</span>
                            <span class="amount" id="faaliyetGiderleri">0</span>
                        </div>
                        <div class="income-item highlight">
                            <span>FAALƒ∞YET KARI/ZARARI</span>
                            <span class="amount" id="faaliyetKari">0</span>
                        </div>
                        <div class="income-item">
                            <span>Diƒüer Gelir/Giderler (Net)</span>
                            <span class="amount" id="digerGelirGider">0</span>
                        </div>
                        <div class="income-item highlight">
                            <span>VERGƒ∞ √ñNCESƒ∞ KAR/ZARAR</span>
                            <span class="amount" id="vergiOncesiKar">0</span>
                        </div>
                        <div class="income-item">
                            <span>Vergi Gideri (-)</span>
                            <span class="amount" id="vergiGideri">0</span>
                        </div>
                        <div class="income-item main-total">
                            <span>D√ñNEM NET KARI/ZARARI</span>
                            <span class="amount" id="donemNetKari">0</span>
                        </div>
                    </div>
                </div>

                <!-- Bottom Section -->
                <div class="bottom-section">
                    <!-- Cash Flow -->
                    <div class="cash-flow">
                        <h2>NAKƒ∞T AKIM TABLOSU</h2>
                        <div class="cash-flow-content">
                            <div class="ratio-item">
                                <span>ƒ∞≈ületme Faaliyetlerinden</span>
                                <span class="ratio-value" id="isletmeFaaliyetleri">0</span>
                            </div>
                            <div class="ratio-item">
                                <span>Yatƒ±rƒ±m Faaliyetlerinden</span>
                                <span class="ratio-value" id="yatirimFaaliyetleri">0</span>
                            </div>
                            <div class="ratio-item">
                                <span>Finansman Faaliyetlerinden</span>
                                <span class="ratio-value" id="finansmanFaaliyetleri">0</span>
                            </div>
                            <div class="ratio-item" style="border-top: 2px solid #4a5568; padding-top: 5px; margin-top: 5px;">
                                <span><strong>Net Nakit Deƒüi≈üimi</strong></span>
                                <span class="ratio-value" id="netNakitDegisimi">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Ratios -->
                    <div class="ratios">
                        <h2>ORANSAL ANALƒ∞ZLER</h2>
                        <div class="ratios-content">
                            <div class="ratio-item">
                                <span>Net ƒ∞≈ületme Sermayesi</span>
                                <span class="ratio-value" id="netIsletmeSermayesi">0</span>
                            </div>
                            <div class="ratio-item">
                                <span>Cari Oran</span>
                                <span class="ratio-value" id="cariOran">0</span>
                            </div>
                            <div class="ratio-item">
                                <span>Alacak Tahsil S√ºresi</span>
                                <span class="ratio-value" id="alacakTahsilSuresi">0 g√ºn</span>
                            </div>
                            <div class="ratio-item">
                                <span>Bor√ß √ñdeme S√ºresi</span>
                                <span class="ratio-value" id="borcOdemeSuresi">0 g√ºn</span>
                            </div>
                            <div class="ratio-item">
                                <span>EBITDA</span>
                                <span class="ratio-value" id="ebitda">0</span>
                            </div>
                            <div class="ratio-item">
                                <span>Br√ºt Finansal Bor√ß</span>
                                <span class="ratio-value" id="brutFinansalBorc">0</span>
                            </div>
                            <div class="ratio-item">
                                <span>Net Finansal Bor√ß</span>
                                <span class="ratio-value" id="netFinansalBorc">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="report-footer">
                    Bu rapor otomatik olarak olu≈üturulmu≈ütur. | Olu≈üturma Tarihi: <span id="reportDate"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Column Mapping Modal -->
    <div class="modal" id="mappingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>S√ºtun E≈üle≈ütirme</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="mapping-info">
                <strong>‚ÑπÔ∏è Bilgi:</strong> Excel dosyanƒ±zdaki s√ºtunlarƒ± e≈üle≈ütirin. Hesap kodu ve tutar s√ºtunlarƒ±nƒ± se√ßin.
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Hesap Kodu S√ºtunu</label>
                    <select id="codeColumn"></select>
                </div>
                <div class="form-group">
                    <label>Hesap Adƒ± S√ºtunu</label>
                    <select id="nameColumn"></select>
                </div>
                <div class="form-group">
                    <label>Bor√ß/Tutar S√ºtunu</label>
                    <select id="debitColumn"></select>
                </div>
                <div class="form-group">
                    <label>Alacak S√ºtunu (Opsiyonel)</label>
                    <select id="creditColumn"></select>
                </div>
            </div>
            <h3 style="margin: 15px 0 10px;">√ñnizleme (ƒ∞lk 5 Satƒ±r)</h3>
            <div style="overflow-x: auto;">
                <table class="preview-table" id="previewTable"></table>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="confirmMapping()">Onayla ve Devam Et</button>
            </div>
        </div>
    </div>

    <script>
        let fileData = null;
        let columnMapping = {};
        let financialData = {};

        // Tek d√ºzen hesap planƒ± gruplarƒ±
        const accountGroups = {
            // D√∂nen Varlƒ±klar (1xx)
            hazirDegerler: ['100', '101', '102', '103', '108'],
            ticariAlacaklar: ['120', '121', '122', '126', '127', '128', '129'],
            stoklar: ['150', '151', '152', '153', '157', '158', '159'],
            digerDonenVarliklar: ['110', '111', '112', '118', '119', '130', '131', '132', '135', '136', '137', '138', '139', '140', '141', '142', '143', '144', '145', '146', '148', '149', '180', '181', '182', '190', '191', '192', '193', '195', '196', '197', '198', '199'],

            // Duran Varlƒ±klar (2xx)
            maddiDuranVarliklar: ['250', '251', '252', '253', '254', '255', '256', '257', '258', '259', '260', '261', '262', '263', '264', '265', '266', '267', '268', '269'],
            maddiOlmayanDV: ['260', '261', '262', '263', '264', '267', '268'],
            digerDuranVarliklar: ['220', '221', '222', '224', '226', '229', '230', '231', '232', '235', '236', '237', '238', '239', '240', '241', '242', '243', '244', '245', '246', '247', '248', '249', '270', '271', '272', '273', '274', '275', '276', '277', '278', '279', '280', '281', '291', '292', '293', '294', '295', '296', '297', '298', '299'],

            // Kƒ±sa Vadeli Yabancƒ± Kaynaklar (3xx)
            kvykMaliBorclar: ['300', '301', '302', '303', '304', '305', '306', '307', '308', '309'],
            ticariBorclar: ['320', '321', '322', '326', '329'],
            kvykDigerBorclar: ['310', '311', '312', '318', '319', '330', '331', '332', '333', '335', '336', '337', '338', '339', '340', '341', '342', '343', '344', '345', '346', '347', '348', '349', '350', '351', '358', '359', '360', '361', '368', '369', '370', '371', '372', '373', '374', '375', '376', '377', '378', '379', '380', '381', '382', '383', '384', '385', '386', '387', '388', '389', '390', '391', '392', '393', '394', '395', '396', '397', '398', '399'],

            // Uzun Vadeli Yabancƒ± Kaynaklar (4xx)
            uvykMaliBorclar: ['400', '401', '402', '403', '404', '405', '406', '407', '408', '409'],
            uvykDigerBorclar: ['410', '411', '412', '418', '419', '420', '421', '422', '426', '429', '430', '431', '432', '433', '435', '436', '437', '438', '439', '440', '441', '442', '443', '444', '445', '446', '447', '448', '449', '450', '451', '452', '453', '454', '455', '456', '457', '458', '459', '460', '461', '462', '463', '464', '465', '466', '467', '468', '469', '470', '471', '472', '473', '474', '475', '476', '477', '478', '479', '480', '481', '482', '483', '484', '485', '486', '487', '488', '489', '490', '491', '492', '493', '494', '495', '496', '497', '498', '499'],

            // √ñzkaynaklar (5xx)
            odenmiserSermaye: ['500', '501', '502'],
            yedekler: ['520', '521', '522', '523', '524', '525', '526', '527', '528', '529', '540', '541', '542', '543', '544', '545', '546', '547', '548', '549'],
            donemKari: ['570', '571', '580', '590', '591'],

            // Gelir Tablosu (6xx)
            netSatislar: ['600', '601', '602', '603', '604'],
            satislarinMaliyeti: ['620', '621', '622', '623', '624', '625'],
            faaliyetGiderleri: ['630', '631', '632', '633', '634'],
            digerGelirler: ['640', '641', '642', '643', '644', '645', '646', '647', '648', '649'],
            digerGiderler: ['653', '654', '655', '656', '657', '658', '659'],
            finansmanGiderleri: ['660', '661'],
            vergiGideri: ['690', '691', '692']
        };

        // DOM Ready
        document.addEventListener('DOMContentLoaded', function() {
            setupDragDrop();
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        });

        // Drag & Drop
        function setupDragDrop() {
            const uploadSection = document.getElementById('uploadSection');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadSection.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadSection.addEventListener(eventName, () => {
                    uploadSection.classList.add('dragover');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadSection.addEventListener(eventName, () => {
                    uploadSection.classList.remove('dragover');
                }, false);
            });

            uploadSection.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length) {
                    document.getElementById('fileInput').files = files;
                    handleFileSelect({ target: { files: files } });
                }
            }, false);
        }

        // File Selection
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            const fileInfo = document.getElementById('fileInfo');
            fileInfo.textContent = `‚úì ${file.name} y√ºklendi`;
            fileInfo.style.display = 'block';

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                fileData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                showMappingModal();
            };
            reader.readAsArrayBuffer(file);
        }

        // Show Mapping Modal
        function showMappingModal() {
            if (!fileData || fileData.length < 2) {
                alert('Dosya bo≈ü veya ge√ßersiz format');
                return;
            }

            const headers = fileData[0];
            const modal = document.getElementById('mappingModal');

            // Populate column selects
            ['codeColumn', 'nameColumn', 'debitColumn', 'creditColumn'].forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">Se√ßiniz...</option>';
                headers.forEach((header, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = header || `S√ºtun ${index + 1}`;
                    select.appendChild(option);
                });
            });

            // Auto-detect columns
            headers.forEach((header, index) => {
                const h = (header || '').toString().toLowerCase();
                if (h.includes('hesap') && (h.includes('kod') || h.includes('no'))) {
                    document.getElementById('codeColumn').value = index;
                } else if (h.includes('hesap') && h.includes('ad')) {
                    document.getElementById('nameColumn').value = index;
                } else if (h.includes('bor√ß') || h.includes('borc') || h.includes('tutar')) {
                    document.getElementById('debitColumn').value = index;
                } else if (h.includes('alacak')) {
                    document.getElementById('creditColumn').value = index;
                }
            });

            // Preview table
            const previewTable = document.getElementById('previewTable');
            let tableHTML = '<thead><tr>';
            headers.forEach(h => {
                tableHTML += `<th>${h || '-'}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';

            for (let i = 1; i < Math.min(6, fileData.length); i++) {
                tableHTML += '<tr>';
                fileData[i].forEach(cell => {
                    tableHTML += `<td>${cell !== undefined ? cell : '-'}</td>`;
                });
                tableHTML += '</tr>';
            }
            tableHTML += '</tbody>';
            previewTable.innerHTML = tableHTML;

            modal.classList.add('show');
        }

        // Confirm Mapping
        function confirmMapping() {
            const codeCol = document.getElementById('codeColumn').value;
            const nameCol = document.getElementById('nameColumn').value;
            const debitCol = document.getElementById('debitColumn').value;
            const creditCol = document.getElementById('creditColumn').value;

            if (!codeCol || !debitCol) {
                alert('L√ºtfen en az Hesap Kodu ve Bor√ß/Tutar s√ºtunlarƒ±nƒ± se√ßin');
                return;
            }

            columnMapping = {
                code: parseInt(codeCol),
                name: nameCol ? parseInt(nameCol) : null,
                debit: parseInt(debitCol),
                credit: creditCol ? parseInt(creditCol) : null
            };

            processData();
            closeModal();
            document.getElementById('companyForm').classList.add('show');
        }

        // Process Data
        function processData() {
            financialData = {};

            // Initialize all groups
            Object.keys(accountGroups).forEach(group => {
                financialData[group] = 0;
            });

            // Process each row
            for (let i = 1; i < fileData.length; i++) {
                const row = fileData[i];
                let code = row[columnMapping.code];
                if (!code) continue;

                code = code.toString().replace(/\D/g, '').substring(0, 3);
                if (!code) continue;

                let amount = parseFloat(row[columnMapping.debit]) || 0;
                if (columnMapping.credit !== null) {
                    const credit = parseFloat(row[columnMapping.credit]) || 0;
                    amount = amount - credit;
                }

                // Find matching group
                for (const [group, codes] of Object.entries(accountGroups)) {
                    if (codes.includes(code)) {
                        financialData[group] += amount;
                        break;
                    }
                }
            }
        }

        // Generate Report
        function generateReport() {
            const companyName = document.getElementById('companyName').value || '≈ûirket Adƒ±';
            const period = document.getElementById('period').value || 'D√∂nem';

            document.getElementById('loading').classList.add('show');
            document.getElementById('companyForm').classList.remove('show');

            setTimeout(() => {
                // Header
                document.getElementById('reportCompanyName').textContent = companyName;
                document.getElementById('reportPeriod').textContent = period;
                document.getElementById('reportDate').textContent = new Date().toLocaleDateString('tr-TR');

                // Calculate totals
                const donenVarliklar = financialData.hazirDegerler + financialData.ticariAlacaklar +
                                       financialData.stoklar + financialData.digerDonenVarliklar;
                const duranVarliklar = financialData.maddiDuranVarliklar + financialData.maddiOlmayanDV +
                                       financialData.digerDuranVarliklar;
                const aktifToplam = donenVarliklar + duranVarliklar;

                const kvyk = financialData.kvykMaliBorclar + financialData.ticariBorclar +
                            financialData.kvykDigerBorclar;
                const uvyk = financialData.uvykMaliBorclar + financialData.uvykDigerBorclar;
                const ozkaynaklar = financialData.odenmiserSermaye + financialData.yedekler +
                                    financialData.donemKari;
                const pasifToplam = kvyk + uvyk + ozkaynaklar;

                // Income statement calculations
                const brutKar = financialData.netSatislar - Math.abs(financialData.satislarinMaliyeti);
                const faaliyetKari = brutKar - Math.abs(financialData.faaliyetGiderleri);
                const digerNet = financialData.digerGelirler - Math.abs(financialData.digerGiderler) -
                                Math.abs(financialData.finansmanGiderleri);
                const vergiOncesiKar = faaliyetKari + digerNet;
                const donemNetKari = vergiOncesiKar - Math.abs(financialData.vergiGideri);

                // Update Balance Sheet - Aktif
                document.getElementById('hazirDegerler').textContent = formatCurrency(financialData.hazirDegerler);
                document.getElementById('ticariAlacaklar').textContent = formatCurrency(financialData.ticariAlacaklar);
                document.getElementById('stoklar').textContent = formatCurrency(financialData.stoklar);
                document.getElementById('digerDonenVarliklar').textContent = formatCurrency(financialData.digerDonenVarliklar);
                document.getElementById('toplamDonenVarliklar').textContent = formatCurrency(donenVarliklar);

                document.getElementById('maddiDuranVarliklar').textContent = formatCurrency(financialData.maddiDuranVarliklar);
                document.getElementById('maddiOlmayanDV').textContent = formatCurrency(financialData.maddiOlmayanDV);
                document.getElementById('digerDuranVarliklar').textContent = formatCurrency(financialData.digerDuranVarliklar);
                document.getElementById('toplamDuranVarliklar').textContent = formatCurrency(duranVarliklar);
                document.getElementById('aktifToplami').textContent = formatCurrency(aktifToplam);

                // Update Balance Sheet - Pasif
                document.getElementById('kvykMaliBorclar').textContent = formatCurrency(financialData.kvykMaliBorclar);
                document.getElementById('ticariBorclar').textContent = formatCurrency(financialData.ticariBorclar);
                document.getElementById('kvykDigerBorclar').textContent = formatCurrency(financialData.kvykDigerBorclar);
                document.getElementById('toplamKVYK').textContent = formatCurrency(kvyk);

                document.getElementById('uvykMaliBorclar').textContent = formatCurrency(financialData.uvykMaliBorclar);
                document.getElementById('uvykDigerBorclar').textContent = formatCurrency(financialData.uvykDigerBorclar);
                document.getElementById('toplamUVYK').textContent = formatCurrency(uvyk);

                document.getElementById('odenmiserSermaye').textContent = formatCurrency(financialData.odenmiserSermaye);
                document.getElementById('yedekler').textContent = formatCurrency(financialData.yedekler);
                document.getElementById('donemKari').textContent = formatCurrency(financialData.donemKari);
                document.getElementById('toplamOzkaynaklar').textContent = formatCurrency(ozkaynaklar);
                document.getElementById('pasifToplami').textContent = formatCurrency(pasifToplam);

                // Update Income Statement
                document.getElementById('netSatislar').textContent = formatCurrency(financialData.netSatislar);
                document.getElementById('satislarinMaliyeti').textContent = formatCurrency(-Math.abs(financialData.satislarinMaliyeti));
                document.getElementById('brutKar').textContent = formatCurrency(brutKar);
                document.getElementById('faaliyetGiderleri').textContent = formatCurrency(-Math.abs(financialData.faaliyetGiderleri));
                document.getElementById('faaliyetKari').textContent = formatCurrency(faaliyetKari);
                document.getElementById('digerGelirGider').textContent = formatCurrency(digerNet);
                document.getElementById('vergiOncesiKar').textContent = formatCurrency(vergiOncesiKar);
                document.getElementById('vergiGideri').textContent = formatCurrency(-Math.abs(financialData.vergiGideri));
                document.getElementById('donemNetKari').textContent = formatCurrency(donemNetKari);

                // Calculate Ratios
                const netIsletmeSermayesi = donenVarliklar - kvyk;
                const cariOran = kvyk !== 0 ? (donenVarliklar / kvyk) : 0;
                const alacakTahsilSuresi = financialData.netSatislar !== 0 ?
                    Math.round((financialData.ticariAlacaklar / financialData.netSatislar) * 365) : 0;
                const borcOdemeSuresi = financialData.satislarinMaliyeti !== 0 ?
                    Math.round((financialData.ticariBorclar / Math.abs(financialData.satislarinMaliyeti)) * 365) : 0;
                const amortisman = 0; // Simplified - would need depreciation data
                const ebitda = faaliyetKari + amortisman;
                const brutFinansalBorc = financialData.kvykMaliBorclar + financialData.uvykMaliBorclar;
                const netFinansalBorc = brutFinansalBorc - financialData.hazirDegerler;

                // Update Ratios
                const nisEl = document.getElementById('netIsletmeSermayesi');
                nisEl.textContent = formatCurrency(netIsletmeSermayesi);
                nisEl.className = 'ratio-value ' + (netIsletmeSermayesi >= 0 ? 'positive' : 'negative');

                document.getElementById('cariOran').textContent = cariOran.toFixed(2);
                document.getElementById('alacakTahsilSuresi').textContent = alacakTahsilSuresi + ' g√ºn';
                document.getElementById('borcOdemeSuresi').textContent = borcOdemeSuresi + ' g√ºn';

                const ebitdaEl = document.getElementById('ebitda');
                ebitdaEl.textContent = formatCurrency(ebitda);
                ebitdaEl.className = 'ratio-value ' + (ebitda >= 0 ? 'positive' : 'negative');

                document.getElementById('brutFinansalBorc').textContent = formatCurrency(brutFinansalBorc);

                const nfbEl = document.getElementById('netFinansalBorc');
                nfbEl.textContent = formatCurrency(netFinansalBorc);
                nfbEl.className = 'ratio-value ' + (netFinansalBorc <= 0 ? 'positive' : 'negative');

                // Cash Flow (simplified estimation)
                const isletmeFaaliyetleri = donemNetKari + amortisman;
                const yatirimFaaliyetleri = -duranVarliklar * 0.1; // Estimated
                const finansmanFaaliyetleri = (brutFinansalBorc - financialData.odenmiserSermaye) * 0.1; // Estimated
                const netNakitDegisimi = isletmeFaaliyetleri + yatirimFaaliyetleri + finansmanFaaliyetleri;

                document.getElementById('isletmeFaaliyetleri').textContent = formatCurrency(isletmeFaaliyetleri);
                document.getElementById('yatirimFaaliyetleri').textContent = formatCurrency(yatirimFaaliyetleri);
                document.getElementById('finansmanFaaliyetleri').textContent = formatCurrency(finansmanFaaliyetleri);
                document.getElementById('netNakitDegisimi').textContent = formatCurrency(netNakitDegisimi);

                // Show report
                document.getElementById('loading').classList.remove('show');
                document.getElementById('reportContainer').classList.add('show');
                document.getElementById('uploadSection').style.display = 'none';

            }, 1000);
        }

        // Format Currency
        function formatCurrency(value) {
            if (value === undefined || value === null || isNaN(value)) return '0';
            return new Intl.NumberFormat('tr-TR', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(Math.round(value));
        }

        // Download PDF
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const report = document.getElementById('report');

            // Show loading
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Olu≈üturuluyor...';
            btn.disabled = true;

            try {
                const canvas = await html2canvas(report, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                const imgX = (pdfWidth - imgWidth * ratio) / 2;
                const imgY = 0;

                pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);

                const companyName = document.getElementById('companyName').value || 'Rapor';
                const period = document.getElementById('period').value || '';
                const fileName = `${companyName}_Yonetici_Ozeti_${period.replace(/\s/g, '_')}.pdf`;

                pdf.save(fileName);
            } catch (error) {
                console.error('PDF olu≈üturma hatasƒ±:', error);
                alert('PDF olu≈üturulurken bir hata olu≈ütu');
            }

            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        // Download Template
        function downloadTemplate() {
            const template = [
                ['Hesap Kodu', 'Hesap Adƒ±', 'Bor√ß', 'Alacak'],
                ['100', 'Kasa', '50000', '0'],
                ['102', 'Bankalar', '500000', '0'],
                ['120', 'Alƒ±cƒ±lar', '750000', '0'],
                ['150', 'ƒ∞lk Madde ve Malzeme', '300000', '0'],
                ['153', 'Ticari Mallar', '450000', '0'],
                ['254', 'Ta≈üƒ±tlar', '200000', '0'],
                ['255', 'Demirba≈ülar', '100000', '0'],
                ['300', 'Banka Kredileri', '0', '400000'],
                ['320', 'Satƒ±cƒ±lar', '0', '350000'],
                ['400', 'Banka Kredileri (Uzun Vadeli)', '0', '500000'],
                ['500', 'Sermaye', '0', '800000'],
                ['540', 'Yasal Yedekler', '0', '100000'],
                ['590', 'D√∂nem Net Karƒ±', '0', '200000'],
                ['600', 'Yurti√ßi Satƒ±≈ülar', '0', '5000000'],
                ['620', 'Satƒ±lan Mamuller Maliyeti', '3500000', '0'],
                ['631', 'Pazarlama Satƒ±≈ü Daƒüƒ±tƒ±m Giderleri', '400000', '0'],
                ['632', 'Genel Y√∂netim Giderleri', '300000', '0'],
                ['660', 'Kƒ±sa Vadeli Bor√ßlanma Giderleri', '100000', '0'],
                ['691', 'D√∂nem Karƒ± Vergi Gideri', '140000', '0']
            ];

            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Mizan');
            XLSX.writeFile(wb, 'Mizan_Sablonu.xlsx');
        }

        // Close Modal
        function closeModal() {
            document.getElementById('mappingModal').classList.remove('show');
        }

        // Reset Form
        function resetForm() {
            fileData = null;
            columnMapping = {};
            financialData = {};

            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('companyForm').classList.remove('show');
            document.getElementById('reportContainer').classList.remove('show');
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('companyName').value = '';
            document.getElementById('period').value = '';
        }
    </script>
</body>
</html>
