<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emlak & Finans Y√∂netim Paneli</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        /* Navigation */
        .main-nav {
            background: linear-gradient(145deg, #0f172a 0%, #1e293b 100%);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 0;
        }

        .nav-brand h1 {
            font-size: 1.3rem;
            color: #e94560;
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
        }

        .nav-tab {
            padding: 20px 30px;
            background: transparent;
            border: none;
            color: #9ca3af;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            color: #fff;
            background: rgba(233, 69, 96, 0.1);
        }

        .nav-tab.active {
            color: #e94560;
            border-bottom-color: #e94560;
            background: rgba(233, 69, 96, 0.1);
        }

        .nav-tab-icon {
            font-size: 1.2rem;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ==================== EMLAK DASHBOARD STYLES ==================== */
        .emlak-header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 2px solid #0f3460;
            margin-bottom: 30px;
        }

        .emlak-header h2 {
            font-size: 1.8rem;
            color: #e94560;
            margin-bottom: 10px;
        }

        .emlak-header p {
            color: #a0a0a0;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid #374151;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.warning {
            border-color: #f59e0b;
            background: linear-gradient(145deg, #451a03 0%, #1c0a00 100%);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #9ca3af;
            font-size: 0.9rem;
        }

        .alerts-section {
            background: linear-gradient(145deg, #7f1d1d 0%, #450a0a 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #dc2626;
            display: none;
        }

        .alerts-section.show {
            display: block;
        }

        .alerts-section h2 {
            color: #fca5a5;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-item {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .alert-badge {
            background: #dc2626;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .form-section {
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #374151;
        }

        .form-section h2 {
            margin-bottom: 20px;
            color: #e94560;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            color: #9ca3af;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #374151;
            background: #111827;
            color: #fff;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #e94560;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(145deg, #e94560 0%, #c73e54 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(145deg, #c73e54 0%, #a33547 100%);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #374151;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-edit {
            background: #2563eb;
            color: white;
        }

        .btn-success {
            background: linear-gradient(145deg, #059669 0%, #047857 100%);
            color: white;
        }

        .form-actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .table-section {
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid #374151;
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-header h2 {
            color: #e94560;
        }

        .search-box {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-box input, .search-box select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #374151;
            background: #111827;
            color: #fff;
            min-width: 200px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #374151;
        }

        th {
            background: #0f172a;
            color: #e94560;
            font-weight: 600;
        }

        tr:hover {
            background: rgba(233, 69, 96, 0.1);
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-active { background: #059669; color: white; }
        .status-warning { background: #f59e0b; color: black; }
        .status-expired { background: #dc2626; color: white; }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-buttons .btn {
            padding: 8px 15px;
            font-size: 0.85rem;
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            color: #6b7280;
        }

        /* ==================== Fƒ∞NANSAL DASHBOARD STYLES ==================== */
        .upload-section {
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            border: 2px dashed #374151;
            text-align: center;
            transition: all 0.3s;
        }

        .upload-section:hover {
            border-color: #e94560;
        }

        .upload-section.dragover {
            border-color: #e94560;
            background: rgba(233, 69, 96, 0.1);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .upload-section h2 {
            margin-bottom: 15px;
        }

        .upload-section p {
            color: #9ca3af;
            margin-bottom: 20px;
        }

        input[type="file"] {
            display: none;
        }

        .file-info {
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(5, 150, 105, 0.2);
            border-radius: 8px;
            color: #10b981;
            display: none;
        }

        .company-form {
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            display: none;
        }

        .company-form.show {
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .report-container {
            display: none;
        }

        .report-container.show {
            display: block;
        }

        .report-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        /* A4 Report */
        .report {
            background: #fff;
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 15mm;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            color: #333;
            font-size: 9pt;
        }

        .report-header {
            text-align: center;
            border-bottom: 3px solid #1a365d;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .report-header h1 {
            font-size: 18pt;
            color: #1a365d;
            margin-bottom: 5px;
        }

        .report-header .company-name {
            font-size: 14pt;
            font-weight: bold;
            color: #2d3748;
        }

        .report-header .period {
            font-size: 10pt;
            color: #718096;
        }

        .balance-sheet {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .sheet-column {
            border: 1px solid #e2e8f0;
        }

        .sheet-column h2 {
            background: #1a365d;
            color: #fff;
            padding: 8px 12px;
            font-size: 11pt;
            text-align: center;
        }

        .sheet-section {
            padding: 8px 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .sheet-section h3 {
            font-size: 9pt;
            color: #1a365d;
            margin-bottom: 5px;
            border-bottom: 1px solid #cbd5e0;
            padding-bottom: 3px;
        }

        .sheet-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            font-size: 8pt;
        }

        .sheet-item.sub-item {
            padding-left: 10px;
            color: #4a5568;
        }

        .sheet-item.total {
            font-weight: bold;
            border-top: 1px solid #cbd5e0;
            margin-top: 3px;
            padding-top: 3px;
        }

        .sheet-item .amount {
            font-family: 'Consolas', monospace;
        }

        .grand-total {
            background: #edf2f7;
            padding: 8px 12px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            font-size: 10pt;
        }

        .income-statement {
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
        }

        .income-statement h2 {
            background: #2d3748;
            color: #fff;
            padding: 8px 12px;
            font-size: 11pt;
            text-align: center;
        }

        .income-content {
            padding: 10px 15px;
        }

        .income-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 8pt;
        }

        .income-item.highlight {
            font-weight: bold;
            background: #f7fafc;
            padding: 5px;
            margin: 3px -5px;
        }

        .income-item.main-total {
            font-weight: bold;
            font-size: 9pt;
            border-top: 2px solid #1a365d;
            margin-top: 5px;
            padding-top: 5px;
        }

        .bottom-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .cash-flow, .ratios {
            border: 1px solid #e2e8f0;
        }

        .cash-flow h2, .ratios h2 {
            background: #4a5568;
            color: #fff;
            padding: 6px 10px;
            font-size: 10pt;
            text-align: center;
        }

        .cash-flow-content, .ratios-content {
            padding: 8px 12px;
        }

        .ratio-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 8pt;
            border-bottom: 1px dotted #e2e8f0;
        }

        .ratio-value {
            font-weight: bold;
            color: #1a365d;
            font-family: 'Consolas', monospace;
        }

        .ratio-value.positive { color: #059669; }
        .ratio-value.negative { color: #dc2626; }

        .report-footer {
            margin-top: 15px;
            text-align: center;
            font-size: 7pt;
            color: #a0aec0;
            border-top: 1px solid #e2e8f0;
            padding-top: 10px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            color: #fff;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #e94560;
        }

        .close-btn {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .mapping-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.85rem;
        }

        .preview-table th, .preview-table td {
            border: 1px solid #374151;
            padding: 8px;
            text-align: left;
        }

        .preview-table th {
            background: #374151;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #374151;
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .nav-container {
                flex-direction: column;
                padding: 10px;
            }

            .nav-tabs {
                width: 100%;
                justify-content: center;
            }

            .nav-tab {
                padding: 15px 20px;
                font-size: 0.9rem;
            }

            .report {
                width: 100%;
                min-height: auto;
                padding: 10px;
            }

            .balance-sheet, .bottom-section {
                grid-template-columns: 1fr;
            }
        }

        @media print {
            body { background: white; }
            .main-nav, .upload-section, .company-form, .report-actions, .tab-content:not(.finans-tab) { display: none !important; }
            .report { box-shadow: none; margin: 0; padding: 10mm; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="main-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <h1>Y√∂netim Paneli</h1>
            </div>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('emlak')">
                    <span class="nav-tab-icon">üè†</span>
                    Emlak Takip
                </button>
                <button class="nav-tab" onclick="switchTab('finans')">
                    <span class="nav-tab-icon">üìä</span>
                    Finansal √ñzet
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- ==================== EMLAK TAKƒ∞P TAB ==================== -->
        <div class="tab-content active" id="emlakTab">
            <div class="emlak-header">
                <h2>Emlak Kiralama Takip Sistemi</h2>
                <p>M√ºlklerinizi ve kiralama s√ºre√ßlerinizi kolayca y√∂netin</p>
            </div>

            <!-- ƒ∞statistik Kartlarƒ± -->
            <div class="stats-container">
                <div class="stat-card">
                    <h3 id="totalProperties">0</h3>
                    <p>Toplam M√ºlk</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalRented">0</h3>
                    <p>Kirada Olan</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalIncome">0 ‚Ç∫</h3>
                    <p>Aylƒ±k Toplam Kira</p>
                </div>
                <div class="stat-card warning">
                    <h3 id="expiringCount">0</h3>
                    <p>1 Ay ƒ∞√ßinde Dolacak</p>
                </div>
            </div>

            <!-- Uyarƒ± B√∂l√ºm√º -->
            <div class="alerts-section" id="alertsSection">
                <h2><span class="pulse">‚ö†Ô∏è</span> Dikkat! S√ºresi Dolmak √úzere Olan Kiralamalar</h2>
                <div id="alertsList"></div>
            </div>

            <!-- Form B√∂l√ºm√º -->
            <div class="form-section">
                <h2 id="formTitle">Yeni M√ºlk Ekle</h2>
                <form id="propertyForm">
                    <input type="hidden" id="editId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="propertyType">M√ºlk T√ºr√º *</label>
                            <select id="propertyType" required>
                                <option value="">Se√ßiniz...</option>
                                <option value="konut">üè† Konut</option>
                                <option value="isyeri">üè¢ ƒ∞≈üyeri</option>
                                <option value="arsa">üåç Arsa</option>
                                <option value="diger">üì¶ Diƒüer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="propertyName">Gayrimenkul Adƒ±/Tanƒ±mƒ± *</label>
                            <input type="text" id="propertyName" placeholder="√ñrn: Kadƒ±k√∂y 3+1 Daire" required>
                        </div>
                        <div class="form-group">
                            <label for="propertyAddress">Adres</label>
                            <input type="text" id="propertyAddress" placeholder="Tam adres">
                        </div>
                        <div class="form-group">
                            <label for="ownerName">M√ºlk Sahibi *</label>
                            <input type="text" id="ownerName" placeholder="M√ºlk sahibinin adƒ±" required>
                        </div>
                        <div class="form-group">
                            <label for="ownerPhone">M√ºlk Sahibi Telefon</label>
                            <input type="tel" id="ownerPhone" placeholder="0555 555 55 55">
                        </div>
                        <div class="form-group">
                            <label for="tenantName">Kiracƒ± Adƒ± *</label>
                            <input type="text" id="tenantName" placeholder="Kiracƒ±nƒ±n adƒ±" required>
                        </div>
                        <div class="form-group">
                            <label for="tenantPhone">Kiracƒ± Telefon</label>
                            <input type="tel" id="tenantPhone" placeholder="0555 555 55 55">
                        </div>
                        <div class="form-group">
                            <label for="rentAmount">Kira Tutarƒ± (‚Ç∫) *</label>
                            <input type="number" id="rentAmount" placeholder="Aylƒ±k kira tutarƒ±" required min="0">
                        </div>
                        <div class="form-group">
                            <label for="startDate">Kiralama Ba≈ülangƒ±√ß Tarihi *</label>
                            <input type="date" id="startDate" required>
                        </div>
                        <div class="form-group">
                            <label for="duration">Kiralama S√ºresi (Ay) *</label>
                            <input type="number" id="duration" placeholder="12" value="12" required min="1">
                        </div>
                        <div class="form-group">
                            <label for="endDate">Kiralama Biti≈ü Tarihi</label>
                            <input type="date" id="endDate" readonly>
                        </div>
                        <div class="form-group">
                            <label for="notes">Notlar</label>
                            <textarea id="notes" rows="2" placeholder="Ek notlar..."></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="submitBtn">Kaydet</button>
                            <button type="button" class="btn btn-secondary" id="cancelBtn" style="display:none;">ƒ∞ptal</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Tablo B√∂l√ºm√º -->
            <div class="table-section">
                <div class="table-header">
                    <h2>M√ºlk Listesi</h2>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Ara...">
                        <select id="filterType">
                            <option value="">T√ºm T√ºrler</option>
                            <option value="konut">üè† Konut</option>
                            <option value="isyeri">üè¢ ƒ∞≈üyeri</option>
                            <option value="arsa">üåç Arsa</option>
                            <option value="diger">üì¶ Diƒüer</option>
                        </select>
                        <select id="filterStatus">
                            <option value="">T√ºm Durumlar</option>
                            <option value="active">Aktif</option>
                            <option value="warning">S√ºresi Dolmak √úzere</option>
                            <option value="expired">S√ºresi Dolmu≈ü</option>
                        </select>
                    </div>
                </div>
                <div id="tableContainer">
                    <table>
                        <thead>
                            <tr>
                                <th>T√ºr</th>
                                <th>Gayrimenkul</th>
                                <th>M√ºlk Sahibi</th>
                                <th>Kiracƒ±</th>
                                <th>Kira (‚Ç∫)</th>
                                <th>Ba≈ülangƒ±√ß</th>
                                <th>Biti≈ü</th>
                                <th>Kalan G√ºn</th>
                                <th>Durum</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody id="propertyTableBody"></tbody>
                    </table>
                </div>
                <div class="empty-state" id="emptyState" style="display:none;">
                    <h3>Hen√ºz kayƒ±tlƒ± m√ºlk yok</h3>
                    <p>Yukarƒ±daki formu kullanarak yeni m√ºlk ekleyebilirsiniz.</p>
                </div>
            </div>
        </div>

        <!-- ==================== Fƒ∞NANSAL √ñZET TAB ==================== -->
        <div class="tab-content finans-tab" id="finansTab">
            <!-- Upload Section -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">üìä</div>
                <h2>Excel veya CSV Dosyasƒ± Y√ºkleyin</h2>
                <p>Mizan, ge√ßici vergi beyannamesi veya kurumlar vergisi dosyanƒ±zƒ± s√ºr√ºkleyip bƒ±rakƒ±n</p>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    üìÅ Dosya Se√ß
                </button>
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
                <div class="file-info" id="fileInfo"></div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="downloadTemplate()">
                        üì• √ñrnek ≈ûablon ƒ∞ndir
                    </button>
                </div>
            </div>

            <!-- Company Info Form -->
            <div class="company-form" id="companyForm">
                <h2 style="margin-bottom: 20px; color: #e94560;">≈ûirket Bilgileri</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>≈ûirket Adƒ± *</label>
                        <input type="text" id="companyName" placeholder="ABC ≈ûirketi A.≈û.">
                    </div>
                    <div class="form-group">
                        <label>D√∂nem *</label>
                        <input type="text" id="period" placeholder="2024 - 4. √áeyrek">
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateReport()">
                        üìÑ Rapor Olu≈ütur
                    </button>
                </div>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Rapor olu≈üturuluyor...</p>
            </div>

            <!-- Report Container -->
            <div class="report-container" id="reportContainer">
                <div class="report-actions">
                    <button class="btn btn-success" onclick="downloadPDF()">
                        üì• PDF ƒ∞ndir
                    </button>
                    <button class="btn btn-secondary" onclick="window.print()">
                        üñ®Ô∏è Yazdƒ±r
                    </button>
                    <button class="btn btn-secondary" onclick="resetFinansForm()">
                        üîÑ Yeni Rapor
                    </button>
                </div>

                <div class="report" id="report">
                    <div class="report-header">
                        <h1>Y√ñNETƒ∞Cƒ∞ √ñZETƒ∞</h1>
                        <div class="company-name" id="reportCompanyName">≈ûirket Adƒ±</div>
                        <div class="period" id="reportPeriod">D√∂nem</div>
                    </div>

                    <!-- Balance Sheet -->
                    <div class="balance-sheet">
                        <!-- Aktif -->
                        <div class="sheet-column">
                            <h2>AKTƒ∞F KALEMLERƒ∞</h2>
                            <div class="sheet-section">
                                <h3>D√ñNEN VARLIKLAR</h3>
                                <div class="sheet-item sub-item"><span>Hazƒ±r Deƒüerler</span><span class="amount" id="hazirDegerler">0</span></div>
                                <div class="sheet-item sub-item"><span>Ticari Alacaklar</span><span class="amount" id="ticariAlacaklar">0</span></div>
                                <div class="sheet-item sub-item"><span>Stoklar</span><span class="amount" id="stoklar">0</span></div>
                                <div class="sheet-item sub-item"><span>Diƒüer D√∂nen Varlƒ±klar</span><span class="amount" id="digerDonenVarliklar">0</span></div>
                                <div class="sheet-item total"><span>TOPLAM D√ñNEN VARLIKLAR</span><span class="amount" id="toplamDonenVarliklar">0</span></div>
                            </div>
                            <div class="sheet-section">
                                <h3>DURAN VARLIKLAR</h3>
                                <div class="sheet-item sub-item"><span>Maddi Duran Varlƒ±klar</span><span class="amount" id="maddiDuranVarliklar">0</span></div>
                                <div class="sheet-item sub-item"><span>Maddi Olmayan D.V.</span><span class="amount" id="maddiOlmayanDV">0</span></div>
                                <div class="sheet-item sub-item"><span>Diƒüer Duran Varlƒ±klar</span><span class="amount" id="digerDuranVarliklar">0</span></div>
                                <div class="sheet-item total"><span>TOPLAM DURAN VARLIKLAR</span><span class="amount" id="toplamDuranVarliklar">0</span></div>
                            </div>
                            <div class="grand-total"><span>AKTƒ∞F TOPLAMI</span><span class="amount" id="aktifToplami">0</span></div>
                        </div>

                        <!-- Pasif -->
                        <div class="sheet-column">
                            <h2>PASƒ∞F KALEMLERƒ∞</h2>
                            <div class="sheet-section">
                                <h3>KISA VADELƒ∞ YABANCI KAYNAKLAR</h3>
                                <div class="sheet-item sub-item"><span>Mali Bor√ßlar</span><span class="amount" id="kvykMaliBorclar">0</span></div>
                                <div class="sheet-item sub-item"><span>Ticari Bor√ßlar</span><span class="amount" id="ticariBorclar">0</span></div>
                                <div class="sheet-item sub-item"><span>Diƒüer Bor√ßlar</span><span class="amount" id="kvykDigerBorclar">0</span></div>
                                <div class="sheet-item total"><span>TOPLAM KVYK</span><span class="amount" id="toplamKVYK">0</span></div>
                            </div>
                            <div class="sheet-section">
                                <h3>UZUN VADELƒ∞ YABANCI KAYNAKLAR</h3>
                                <div class="sheet-item sub-item"><span>Mali Bor√ßlar</span><span class="amount" id="uvykMaliBorclar">0</span></div>
                                <div class="sheet-item sub-item"><span>Diƒüer Bor√ßlar</span><span class="amount" id="uvykDigerBorclar">0</span></div>
                                <div class="sheet-item total"><span>TOPLAM UVYK</span><span class="amount" id="toplamUVYK">0</span></div>
                            </div>
                            <div class="sheet-section">
                                <h3>√ñZKAYNAKLAR</h3>
                                <div class="sheet-item sub-item"><span>√ñdenmi≈ü Sermaye</span><span class="amount" id="odenmiserSermaye">0</span></div>
                                <div class="sheet-item sub-item"><span>Yedekler</span><span class="amount" id="yedekler">0</span></div>
                                <div class="sheet-item sub-item"><span>D√∂nem Karƒ±/Zararƒ±</span><span class="amount" id="donemKari">0</span></div>
                                <div class="sheet-item total"><span>TOPLAM √ñZKAYNAKLAR</span><span class="amount" id="toplamOzkaynaklar">0</span></div>
                            </div>
                            <div class="grand-total"><span>PASƒ∞F TOPLAMI</span><span class="amount" id="pasifToplami">0</span></div>
                        </div>
                    </div>

                    <!-- Income Statement -->
                    <div class="income-statement">
                        <h2>GELƒ∞R TABLOSU</h2>
                        <div class="income-content">
                            <div class="income-item"><span>Net Satƒ±≈ülar</span><span class="amount" id="netSatislar">0</span></div>
                            <div class="income-item"><span>Satƒ±≈ülarƒ±n Maliyeti (-)</span><span class="amount" id="satislarinMaliyeti">0</span></div>
                            <div class="income-item highlight"><span>BR√úT KAR/ZARAR</span><span class="amount" id="brutKar">0</span></div>
                            <div class="income-item"><span>Faaliyet Giderleri (-)</span><span class="amount" id="faaliyetGiderleri">0</span></div>
                            <div class="income-item highlight"><span>FAALƒ∞YET KARI/ZARARI</span><span class="amount" id="faaliyetKari">0</span></div>
                            <div class="income-item"><span>Diƒüer Gelir/Giderler (Net)</span><span class="amount" id="digerGelirGider">0</span></div>
                            <div class="income-item highlight"><span>VERGƒ∞ √ñNCESƒ∞ KAR/ZARAR</span><span class="amount" id="vergiOncesiKar">0</span></div>
                            <div class="income-item"><span>Vergi Gideri (-)</span><span class="amount" id="vergiGideri">0</span></div>
                            <div class="income-item main-total"><span>D√ñNEM NET KARI/ZARARI</span><span class="amount" id="donemNetKari">0</span></div>
                        </div>
                    </div>

                    <!-- Bottom Section -->
                    <div class="bottom-section">
                        <div class="cash-flow">
                            <h2>NAKƒ∞T AKIM TABLOSU</h2>
                            <div class="cash-flow-content">
                                <div class="ratio-item"><span>ƒ∞≈ületme Faaliyetlerinden</span><span class="ratio-value" id="isletmeFaaliyetleri">0</span></div>
                                <div class="ratio-item"><span>Yatƒ±rƒ±m Faaliyetlerinden</span><span class="ratio-value" id="yatirimFaaliyetleri">0</span></div>
                                <div class="ratio-item"><span>Finansman Faaliyetlerinden</span><span class="ratio-value" id="finansmanFaaliyetleri">0</span></div>
                                <div class="ratio-item" style="border-top: 2px solid #4a5568; padding-top: 5px; margin-top: 5px;"><span><strong>Net Nakit Deƒüi≈üimi</strong></span><span class="ratio-value" id="netNakitDegisimi">0</span></div>
                            </div>
                        </div>
                        <div class="ratios">
                            <h2>ORANSAL ANALƒ∞ZLER</h2>
                            <div class="ratios-content">
                                <div class="ratio-item"><span>Net ƒ∞≈ületme Sermayesi</span><span class="ratio-value" id="netIsletmeSermayesi">0</span></div>
                                <div class="ratio-item"><span>Cari Oran</span><span class="ratio-value" id="cariOran">0</span></div>
                                <div class="ratio-item"><span>Alacak Tahsil S√ºresi</span><span class="ratio-value" id="alacakTahsilSuresi">0 g√ºn</span></div>
                                <div class="ratio-item"><span>Bor√ß √ñdeme S√ºresi</span><span class="ratio-value" id="borcOdemeSuresi">0 g√ºn</span></div>
                                <div class="ratio-item"><span>EBITDA</span><span class="ratio-value" id="ebitda">0</span></div>
                                <div class="ratio-item"><span>Br√ºt Finansal Bor√ß</span><span class="ratio-value" id="brutFinansalBorc">0</span></div>
                                <div class="ratio-item"><span>Net Finansal Bor√ß</span><span class="ratio-value" id="netFinansalBorc">0</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="report-footer">
                        Bu rapor otomatik olarak olu≈üturulmu≈ütur. | Olu≈üturma Tarihi: <span id="reportDate"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Column Mapping Modal -->
    <div class="modal" id="mappingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>S√ºtun E≈üle≈ütirme</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="mapping-info">
                <strong>‚ÑπÔ∏è Bilgi:</strong> Excel dosyanƒ±zdaki s√ºtunlarƒ± e≈üle≈ütirin.
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Hesap Kodu S√ºtunu</label>
                    <select id="codeColumn"></select>
                </div>
                <div class="form-group">
                    <label>Hesap Adƒ± S√ºtunu</label>
                    <select id="nameColumn"></select>
                </div>
                <div class="form-group">
                    <label>Bor√ß/Tutar S√ºtunu</label>
                    <select id="debitColumn"></select>
                </div>
                <div class="form-group">
                    <label>Alacak S√ºtunu (Opsiyonel)</label>
                    <select id="creditColumn"></select>
                </div>
            </div>
            <h3 style="margin: 15px 0 10px;">√ñnizleme (ƒ∞lk 5 Satƒ±r)</h3>
            <div style="overflow-x: auto;">
                <table class="preview-table" id="previewTable"></table>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="confirmMapping()">Onayla ve Devam Et</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== TAB NAVIGATION ====================
        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (tab === 'emlak') {
                document.querySelector('.nav-tab:nth-child(1)').classList.add('active');
                document.getElementById('emlakTab').classList.add('active');
            } else {
                document.querySelector('.nav-tab:nth-child(2)').classList.add('active');
                document.getElementById('finansTab').classList.add('active');
            }
        }

        // ==================== EMLAK TAKƒ∞P ====================
        let properties = JSON.parse(localStorage.getItem('emlakProperties')) || [];
        let editMode = false;

        document.addEventListener('DOMContentLoaded', function() {
            // Emlak
            renderTable();
            updateStats();
            checkAlerts();
            document.getElementById('startDate').addEventListener('change', calculateEndDate);
            document.getElementById('duration').addEventListener('change', calculateEndDate);
            document.getElementById('searchInput').addEventListener('input', renderTable);
            document.getElementById('filterType').addEventListener('change', renderTable);
            document.getElementById('filterStatus').addEventListener('change', renderTable);

            // Finans
            setupDragDrop();
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        });

        function calculateEndDate() {
            const startDate = document.getElementById('startDate').value;
            const duration = parseInt(document.getElementById('duration').value) || 12;
            if (startDate) {
                const start = new Date(startDate);
                start.setMonth(start.getMonth() + duration);
                document.getElementById('endDate').value = start.toISOString().split('T')[0];
            }
        }

        document.getElementById('propertyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const property = {
                id: editMode ? document.getElementById('editId').value : Date.now().toString(),
                type: document.getElementById('propertyType').value,
                name: document.getElementById('propertyName').value,
                address: document.getElementById('propertyAddress').value,
                ownerName: document.getElementById('ownerName').value,
                ownerPhone: document.getElementById('ownerPhone').value,
                tenantName: document.getElementById('tenantName').value,
                tenantPhone: document.getElementById('tenantPhone').value,
                rentAmount: parseFloat(document.getElementById('rentAmount').value),
                startDate: document.getElementById('startDate').value,
                duration: parseInt(document.getElementById('duration').value),
                endDate: document.getElementById('endDate').value,
                notes: document.getElementById('notes').value,
                createdAt: editMode ? properties.find(p => p.id === document.getElementById('editId').value)?.createdAt : new Date().toISOString()
            };

            if (editMode) {
                const index = properties.findIndex(p => p.id === property.id);
                properties[index] = property;
                editMode = false;
                document.getElementById('formTitle').textContent = 'Yeni M√ºlk Ekle';
                document.getElementById('submitBtn').textContent = 'Kaydet';
                document.getElementById('cancelBtn').style.display = 'none';
            } else {
                properties.push(property);
            }

            saveData();
            this.reset();
            document.getElementById('duration').value = '12';
            renderTable();
            updateStats();
            checkAlerts();
        });

        document.getElementById('cancelBtn').addEventListener('click', function() {
            editMode = false;
            document.getElementById('propertyForm').reset();
            document.getElementById('duration').value = '12';
            document.getElementById('formTitle').textContent = 'Yeni M√ºlk Ekle';
            document.getElementById('submitBtn').textContent = 'Kaydet';
            this.style.display = 'none';
        });

        function saveData() {
            localStorage.setItem('emlakProperties', JSON.stringify(properties));
        }

        function renderTable() {
            const tbody = document.getElementById('propertyTableBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterType = document.getElementById('filterType').value;
            const filterStatus = document.getElementById('filterStatus').value;

            let filtered = properties.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(searchTerm) ||
                                     p.ownerName.toLowerCase().includes(searchTerm) ||
                                     p.tenantName.toLowerCase().includes(searchTerm) ||
                                     (p.address && p.address.toLowerCase().includes(searchTerm));
                const matchesType = !filterType || p.type === filterType;
                const status = getStatus(p);
                const matchesStatus = !filterStatus || status.key === filterStatus;
                return matchesSearch && matchesType && matchesStatus;
            });

            filtered.sort((a, b) => new Date(a.endDate) - new Date(b.endDate));

            if (filtered.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('tableContainer').querySelector('table').style.display = 'none';
                return;
            }

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('tableContainer').querySelector('table').style.display = 'table';

            const typeIcons = { 'konut': 'üè†', 'isyeri': 'üè¢', 'arsa': 'üåç', 'diger': 'üì¶' };
            const typeNames = { 'konut': 'Konut', 'isyeri': 'ƒ∞≈üyeri', 'arsa': 'Arsa', 'diger': 'Diƒüer' };

            tbody.innerHTML = filtered.map(p => {
                const status = getStatus(p);
                const daysLeft = getDaysLeft(p.endDate);
                return `
                    <tr>
                        <td><span>${typeIcons[p.type]}</span> ${typeNames[p.type]}</td>
                        <td><strong>${p.name}</strong><br><small style="color:#9ca3af">${p.address || '-'}</small></td>
                        <td>${p.ownerName}<br><small style="color:#9ca3af">${p.ownerPhone || '-'}</small></td>
                        <td>${p.tenantName}<br><small style="color:#9ca3af">${p.tenantPhone || '-'}</small></td>
                        <td><strong>${p.rentAmount.toLocaleString('tr-TR')} ‚Ç∫</strong></td>
                        <td>${formatDate(p.startDate)}</td>
                        <td>${formatDate(p.endDate)}</td>
                        <td><strong>${daysLeft}</strong> g√ºn</td>
                        <td><span class="status-badge status-${status.key}">${status.label}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-edit" onclick="editProperty('${p.id}')">D√ºzenle</button>
                                <button class="btn btn-danger" onclick="deleteProperty('${p.id}')">Sil</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getStatus(property) {
            const daysLeft = getDaysLeft(property.endDate);
            if (daysLeft < 0) return { key: 'expired', label: 'S√ºresi Dolmu≈ü' };
            if (daysLeft <= 30) return { key: 'warning', label: 'S√ºresi Dolmak √úzere' };
            return { key: 'active', label: 'Aktif' };
        }

        function getDaysLeft(endDate) {
            const end = new Date(endDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            end.setHours(0, 0, 0, 0);
            return Math.ceil((end - today) / (1000 * 60 * 60 * 24));
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('tr-TR');
        }

        function updateStats() {
            const total = properties.length;
            const rented = properties.filter(p => getDaysLeft(p.endDate) >= 0).length;
            const totalIncome = properties.filter(p => getDaysLeft(p.endDate) >= 0).reduce((sum, p) => sum + p.rentAmount, 0);
            const expiring = properties.filter(p => { const d = getDaysLeft(p.endDate); return d >= 0 && d <= 30; }).length;

            document.getElementById('totalProperties').textContent = total;
            document.getElementById('totalRented').textContent = rented;
            document.getElementById('totalIncome').textContent = totalIncome.toLocaleString('tr-TR') + ' ‚Ç∫';
            document.getElementById('expiringCount').textContent = expiring;
        }

        function checkAlerts() {
            const alertsSection = document.getElementById('alertsSection');
            const alertsList = document.getElementById('alertsList');
            const expiringProperties = properties.filter(p => { const d = getDaysLeft(p.endDate); return d >= 0 && d <= 30; }).sort((a, b) => getDaysLeft(a.endDate) - getDaysLeft(b.endDate));

            if (expiringProperties.length === 0) {
                alertsSection.classList.remove('show');
                return;
            }

            alertsSection.classList.add('show');
            alertsList.innerHTML = expiringProperties.map(p => `
                <div class="alert-item">
                    <div><strong>${p.name}</strong> - Kiracƒ±: ${p.tenantName}<br><small>Biti≈ü: ${formatDate(p.endDate)}</small></div>
                    <span class="alert-badge">${getDaysLeft(p.endDate)} g√ºn kaldƒ±</span>
                </div>
            `).join('');
        }

        function editProperty(id) {
            const property = properties.find(p => p.id === id);
            if (!property) return;

            editMode = true;
            document.getElementById('editId').value = property.id;
            document.getElementById('propertyType').value = property.type;
            document.getElementById('propertyName').value = property.name;
            document.getElementById('propertyAddress').value = property.address || '';
            document.getElementById('ownerName').value = property.ownerName;
            document.getElementById('ownerPhone').value = property.ownerPhone || '';
            document.getElementById('tenantName').value = property.tenantName;
            document.getElementById('tenantPhone').value = property.tenantPhone || '';
            document.getElementById('rentAmount').value = property.rentAmount;
            document.getElementById('startDate').value = property.startDate;
            document.getElementById('duration').value = property.duration;
            document.getElementById('endDate').value = property.endDate;
            document.getElementById('notes').value = property.notes || '';

            document.getElementById('formTitle').textContent = 'M√ºlk D√ºzenle';
            document.getElementById('submitBtn').textContent = 'G√ºncelle';
            document.getElementById('cancelBtn').style.display = 'inline-block';
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteProperty(id) {
            if (confirm('Bu m√ºlk√º silmek istediƒüinizden emin misiniz?')) {
                properties = properties.filter(p => p.id !== id);
                saveData();
                renderTable();
                updateStats();
                checkAlerts();
            }
        }

        // ==================== Fƒ∞NANSAL √ñZET ====================
        let fileData = null;
        let columnMapping = {};
        let financialData = {};

        const accountGroups = {
            hazirDegerler: ['100', '101', '102', '103', '108'],
            ticariAlacaklar: ['120', '121', '122', '126', '127', '128', '129'],
            stoklar: ['150', '151', '152', '153', '157', '158', '159'],
            digerDonenVarliklar: ['110', '111', '112', '118', '119', '130', '131', '132', '135', '136', '137', '138', '139', '140', '141', '142', '143', '144', '145', '146', '148', '149', '180', '181', '182', '190', '191', '192', '193', '195', '196', '197', '198', '199'],
            maddiDuranVarliklar: ['250', '251', '252', '253', '254', '255', '256', '257', '258', '259'],
            maddiOlmayanDV: ['260', '261', '262', '263', '264', '267', '268'],
            digerDuranVarliklar: ['220', '221', '222', '224', '226', '229', '230', '231', '232', '235', '236', '237', '238', '239', '240', '241', '242', '243', '244', '245', '246', '247', '248', '249', '270', '271', '272', '273', '274', '275', '276', '277', '278', '279', '280', '281', '291', '292', '293', '294', '295', '296', '297', '298', '299'],
            kvykMaliBorclar: ['300', '301', '302', '303', '304', '305', '306', '307', '308', '309'],
            ticariBorclar: ['320', '321', '322', '326', '329'],
            kvykDigerBorclar: ['310', '311', '312', '318', '319', '330', '331', '332', '333', '335', '336', '337', '338', '339', '340', '341', '342', '343', '344', '345', '346', '347', '348', '349', '350', '351', '358', '359', '360', '361', '368', '369', '370', '371', '372', '373', '374', '375', '376', '377', '378', '379', '380', '381', '382', '383', '384', '385', '386', '387', '388', '389', '390', '391', '392', '393', '394', '395', '396', '397', '398', '399'],
            uvykMaliBorclar: ['400', '401', '402', '403', '404', '405', '406', '407', '408', '409'],
            uvykDigerBorclar: ['410', '411', '412', '418', '419', '420', '421', '422', '426', '429', '430', '431', '432', '433', '435', '436', '437', '438', '439', '440', '441', '442', '443', '444', '445', '446', '447', '448', '449', '450', '451', '452', '453', '454', '455', '456', '457', '458', '459', '472', '473', '474', '475', '476', '477', '478', '479', '480', '481', '482', '483', '484', '485', '486', '487', '488', '489', '490', '491', '492', '493', '494', '495', '496', '497', '498', '499'],
            odenmiserSermaye: ['500', '501', '502'],
            yedekler: ['520', '521', '522', '523', '524', '525', '526', '527', '528', '529', '540', '541', '542', '543', '544', '545', '546', '547', '548', '549'],
            donemKari: ['570', '571', '580', '590', '591'],
            netSatislar: ['600', '601', '602', '603', '604'],
            satislarinMaliyeti: ['620', '621', '622', '623', '624', '625'],
            faaliyetGiderleri: ['630', '631', '632', '633', '634'],
            digerGelirler: ['640', '641', '642', '643', '644', '645', '646', '647', '648', '649'],
            digerGiderler: ['653', '654', '655', '656', '657', '658', '659'],
            finansmanGiderleri: ['660', '661'],
            vergiGideri: ['690', '691', '692']
        };

        function setupDragDrop() {
            const uploadSection = document.getElementById('uploadSection');
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => uploadSection.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }, false));
            ['dragenter', 'dragover'].forEach(e => uploadSection.addEventListener(e, () => uploadSection.classList.add('dragover'), false));
            ['dragleave', 'drop'].forEach(e => uploadSection.addEventListener(e, () => uploadSection.classList.remove('dragover'), false));
            uploadSection.addEventListener('drop', e => {
                const files = e.dataTransfer.files;
                if (files.length) {
                    document.getElementById('fileInput').files = files;
                    handleFileSelect({ target: { files: files } });
                }
            }, false);
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('fileInfo').textContent = `‚úì ${file.name} y√ºklendi`;
            document.getElementById('fileInfo').style.display = 'block';

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                fileData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                showMappingModal();
            };
            reader.readAsArrayBuffer(file);
        }

        function showMappingModal() {
            if (!fileData || fileData.length < 2) { alert('Dosya bo≈ü veya ge√ßersiz'); return; }
            const headers = fileData[0];
            const modal = document.getElementById('mappingModal');

            ['codeColumn', 'nameColumn', 'debitColumn', 'creditColumn'].forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">Se√ßiniz...</option>';
                headers.forEach((h, i) => { select.innerHTML += `<option value="${i}">${h || 'S√ºtun ' + (i+1)}</option>`; });
            });

            headers.forEach((h, i) => {
                const hl = (h || '').toString().toLowerCase();
                if (hl.includes('hesap') && (hl.includes('kod') || hl.includes('no'))) document.getElementById('codeColumn').value = i;
                else if (hl.includes('hesap') && hl.includes('ad')) document.getElementById('nameColumn').value = i;
                else if (hl.includes('bor√ß') || hl.includes('borc') || hl.includes('tutar')) document.getElementById('debitColumn').value = i;
                else if (hl.includes('alacak')) document.getElementById('creditColumn').value = i;
            });

            let tableHTML = '<thead><tr>' + headers.map(h => `<th>${h || '-'}</th>`).join('') + '</tr></thead><tbody>';
            for (let i = 1; i < Math.min(6, fileData.length); i++) {
                tableHTML += '<tr>' + fileData[i].map(c => `<td>${c !== undefined ? c : '-'}</td>`).join('') + '</tr>';
            }
            document.getElementById('previewTable').innerHTML = tableHTML + '</tbody>';
            modal.classList.add('show');
        }

        function confirmMapping() {
            const codeCol = document.getElementById('codeColumn').value;
            const debitCol = document.getElementById('debitColumn').value;
            if (!codeCol || !debitCol) { alert('Hesap Kodu ve Bor√ß s√ºtunlarƒ±nƒ± se√ßin'); return; }

            columnMapping = {
                code: parseInt(codeCol),
                name: document.getElementById('nameColumn').value ? parseInt(document.getElementById('nameColumn').value) : null,
                debit: parseInt(debitCol),
                credit: document.getElementById('creditColumn').value ? parseInt(document.getElementById('creditColumn').value) : null
            };

            processData();
            closeModal();
            document.getElementById('companyForm').classList.add('show');
        }

        function processData() {
            financialData = {};
            Object.keys(accountGroups).forEach(g => financialData[g] = 0);

            for (let i = 1; i < fileData.length; i++) {
                const row = fileData[i];
                let code = row[columnMapping.code];
                if (!code) continue;
                code = code.toString().replace(/\D/g, '').substring(0, 3);
                if (!code) continue;

                let amount = parseFloat(row[columnMapping.debit]) || 0;
                if (columnMapping.credit !== null) amount -= (parseFloat(row[columnMapping.credit]) || 0);

                for (const [group, codes] of Object.entries(accountGroups)) {
                    if (codes.includes(code)) { financialData[group] += amount; break; }
                }
            }
        }

        function generateReport() {
            const companyName = document.getElementById('companyName').value || '≈ûirket Adƒ±';
            const period = document.getElementById('period').value || 'D√∂nem';

            document.getElementById('loading').classList.add('show');
            document.getElementById('companyForm').classList.remove('show');

            setTimeout(() => {
                document.getElementById('reportCompanyName').textContent = companyName;
                document.getElementById('reportPeriod').textContent = period;
                document.getElementById('reportDate').textContent = new Date().toLocaleDateString('tr-TR');

                const dv = financialData.hazirDegerler + financialData.ticariAlacaklar + financialData.stoklar + financialData.digerDonenVarliklar;
                const duran = financialData.maddiDuranVarliklar + financialData.maddiOlmayanDV + financialData.digerDuranVarliklar;
                const aktif = dv + duran;
                const kvyk = financialData.kvykMaliBorclar + financialData.ticariBorclar + financialData.kvykDigerBorclar;
                const uvyk = financialData.uvykMaliBorclar + financialData.uvykDigerBorclar;
                const ozk = financialData.odenmiserSermaye + financialData.yedekler + financialData.donemKari;
                const pasif = kvyk + uvyk + ozk;

                const brutKar = financialData.netSatislar - Math.abs(financialData.satislarinMaliyeti);
                const faaliyetKari = brutKar - Math.abs(financialData.faaliyetGiderleri);
                const digerNet = financialData.digerGelirler - Math.abs(financialData.digerGiderler) - Math.abs(financialData.finansmanGiderleri);
                const vokKar = faaliyetKari + digerNet;
                const netKar = vokKar - Math.abs(financialData.vergiGideri);

                // Aktif
                document.getElementById('hazirDegerler').textContent = formatCurrency(financialData.hazirDegerler);
                document.getElementById('ticariAlacaklar').textContent = formatCurrency(financialData.ticariAlacaklar);
                document.getElementById('stoklar').textContent = formatCurrency(financialData.stoklar);
                document.getElementById('digerDonenVarliklar').textContent = formatCurrency(financialData.digerDonenVarliklar);
                document.getElementById('toplamDonenVarliklar').textContent = formatCurrency(dv);
                document.getElementById('maddiDuranVarliklar').textContent = formatCurrency(financialData.maddiDuranVarliklar);
                document.getElementById('maddiOlmayanDV').textContent = formatCurrency(financialData.maddiOlmayanDV);
                document.getElementById('digerDuranVarliklar').textContent = formatCurrency(financialData.digerDuranVarliklar);
                document.getElementById('toplamDuranVarliklar').textContent = formatCurrency(duran);
                document.getElementById('aktifToplami').textContent = formatCurrency(aktif);

                // Pasif
                document.getElementById('kvykMaliBorclar').textContent = formatCurrency(financialData.kvykMaliBorclar);
                document.getElementById('ticariBorclar').textContent = formatCurrency(financialData.ticariBorclar);
                document.getElementById('kvykDigerBorclar').textContent = formatCurrency(financialData.kvykDigerBorclar);
                document.getElementById('toplamKVYK').textContent = formatCurrency(kvyk);
                document.getElementById('uvykMaliBorclar').textContent = formatCurrency(financialData.uvykMaliBorclar);
                document.getElementById('uvykDigerBorclar').textContent = formatCurrency(financialData.uvykDigerBorclar);
                document.getElementById('toplamUVYK').textContent = formatCurrency(uvyk);
                document.getElementById('odenmiserSermaye').textContent = formatCurrency(financialData.odenmiserSermaye);
                document.getElementById('yedekler').textContent = formatCurrency(financialData.yedekler);
                document.getElementById('donemKari').textContent = formatCurrency(financialData.donemKari);
                document.getElementById('toplamOzkaynaklar').textContent = formatCurrency(ozk);
                document.getElementById('pasifToplami').textContent = formatCurrency(pasif);

                // Gelir Tablosu
                document.getElementById('netSatislar').textContent = formatCurrency(financialData.netSatislar);
                document.getElementById('satislarinMaliyeti').textContent = formatCurrency(-Math.abs(financialData.satislarinMaliyeti));
                document.getElementById('brutKar').textContent = formatCurrency(brutKar);
                document.getElementById('faaliyetGiderleri').textContent = formatCurrency(-Math.abs(financialData.faaliyetGiderleri));
                document.getElementById('faaliyetKari').textContent = formatCurrency(faaliyetKari);
                document.getElementById('digerGelirGider').textContent = formatCurrency(digerNet);
                document.getElementById('vergiOncesiKar').textContent = formatCurrency(vokKar);
                document.getElementById('vergiGideri').textContent = formatCurrency(-Math.abs(financialData.vergiGideri));
                document.getElementById('donemNetKari').textContent = formatCurrency(netKar);

                // Oranlar
                const nis = dv - kvyk;
                const cari = kvyk !== 0 ? (dv / kvyk) : 0;
                const ats = financialData.netSatislar !== 0 ? Math.round((financialData.ticariAlacaklar / financialData.netSatislar) * 365) : 0;
                const bos = financialData.satislarinMaliyeti !== 0 ? Math.round((financialData.ticariBorclar / Math.abs(financialData.satislarinMaliyeti)) * 365) : 0;
                const ebitda = faaliyetKari;
                const bfb = financialData.kvykMaliBorclar + financialData.uvykMaliBorclar;
                const nfb = bfb - financialData.hazirDegerler;

                const nisEl = document.getElementById('netIsletmeSermayesi');
                nisEl.textContent = formatCurrency(nis);
                nisEl.className = 'ratio-value ' + (nis >= 0 ? 'positive' : 'negative');
                document.getElementById('cariOran').textContent = cari.toFixed(2);
                document.getElementById('alacakTahsilSuresi').textContent = ats + ' g√ºn';
                document.getElementById('borcOdemeSuresi').textContent = bos + ' g√ºn';
                const ebitdaEl = document.getElementById('ebitda');
                ebitdaEl.textContent = formatCurrency(ebitda);
                ebitdaEl.className = 'ratio-value ' + (ebitda >= 0 ? 'positive' : 'negative');
                document.getElementById('brutFinansalBorc').textContent = formatCurrency(bfb);
                const nfbEl = document.getElementById('netFinansalBorc');
                nfbEl.textContent = formatCurrency(nfb);
                nfbEl.className = 'ratio-value ' + (nfb <= 0 ? 'positive' : 'negative');

                // Nakit Akƒ±m
                const isletme = netKar;
                const yatirim = -duran * 0.1;
                const finansman = (bfb - financialData.odenmiserSermaye) * 0.1;
                document.getElementById('isletmeFaaliyetleri').textContent = formatCurrency(isletme);
                document.getElementById('yatirimFaaliyetleri').textContent = formatCurrency(yatirim);
                document.getElementById('finansmanFaaliyetleri').textContent = formatCurrency(finansman);
                document.getElementById('netNakitDegisimi').textContent = formatCurrency(isletme + yatirim + finansman);

                document.getElementById('loading').classList.remove('show');
                document.getElementById('reportContainer').classList.add('show');
                document.getElementById('uploadSection').style.display = 'none';
            }, 1000);
        }

        function formatCurrency(v) {
            if (v === undefined || v === null || isNaN(v)) return '0';
            return new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(Math.round(v));
        }

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const btn = event.target;
            btn.innerHTML = '‚è≥ Olu≈üturuluyor...';
            btn.disabled = true;

            try {
                const canvas = await html2canvas(document.getElementById('report'), { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfW = pdf.internal.pageSize.getWidth();
                const pdfH = pdf.internal.pageSize.getHeight();
                const ratio = Math.min(pdfW / canvas.width, pdfH / canvas.height);
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', (pdfW - canvas.width * ratio) / 2, 0, canvas.width * ratio, canvas.height * ratio);
                pdf.save(`${document.getElementById('companyName').value || 'Rapor'}_Yonetici_Ozeti.pdf`);
            } catch (e) {
                alert('PDF olu≈üturulurken hata olu≈ütu');
            }
            btn.innerHTML = 'üì• PDF ƒ∞ndir';
            btn.disabled = false;
        }

        function downloadTemplate() {
            const template = [
                ['Hesap Kodu', 'Hesap Adƒ±', 'Bor√ß', 'Alacak'],
                ['100', 'Kasa', '50000', '0'],
                ['102', 'Bankalar', '500000', '0'],
                ['120', 'Alƒ±cƒ±lar', '750000', '0'],
                ['150', 'ƒ∞lk Madde ve Malzeme', '300000', '0'],
                ['153', 'Ticari Mallar', '450000', '0'],
                ['254', 'Ta≈üƒ±tlar', '200000', '0'],
                ['255', 'Demirba≈ülar', '100000', '0'],
                ['300', 'Banka Kredileri', '0', '400000'],
                ['320', 'Satƒ±cƒ±lar', '0', '350000'],
                ['400', 'Banka Kredileri (Uzun Vadeli)', '0', '500000'],
                ['500', 'Sermaye', '0', '800000'],
                ['540', 'Yasal Yedekler', '0', '100000'],
                ['590', 'D√∂nem Net Karƒ±', '0', '200000'],
                ['600', 'Yurti√ßi Satƒ±≈ülar', '0', '5000000'],
                ['620', 'Satƒ±lan Mamuller Maliyeti', '3500000', '0'],
                ['631', 'Pazarlama Satƒ±≈ü Daƒüƒ±tƒ±m Giderleri', '400000', '0'],
                ['632', 'Genel Y√∂netim Giderleri', '300000', '0'],
                ['660', 'Kƒ±sa Vadeli Bor√ßlanma Giderleri', '100000', '0'],
                ['691', 'D√∂nem Karƒ± Vergi Gideri', '140000', '0']
            ];
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Mizan');
            XLSX.writeFile(wb, 'Mizan_Sablonu.xlsx');
        }

        function closeModal() {
            document.getElementById('mappingModal').classList.remove('show');
        }

        function resetFinansForm() {
            fileData = null;
            columnMapping = {};
            financialData = {};
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('companyForm').classList.remove('show');
            document.getElementById('reportContainer').classList.remove('show');
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('companyName').value = '';
            document.getElementById('period').value = '';
        }
    </script>
</body>
</html>
